<!doctype html><html lang=en data-theme=light><head><title>David Issa Mattos | Writing R packages With Stan</title><meta charset=utf-8><meta name=generator content="Hugo 0.95.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=description content="I am interest in research, statistics and causal inference in the context of software development."><link rel=stylesheet href=https://davidissamattos.github.io/css/style.min.cb45dfe6ccf9b3233c817bf2a0c4d9e59d03c2434f4352fe365f78458df688cf.css integrity="sha256-y0Xf5sz5syM8gXvyoMTZ5Z0DwkNPQ1L+Nl94RY32iM8=" crossorigin=anonymous type=text/css><link rel=stylesheet href=https://davidissamattos.github.io/css/markupHighlight.min.8735c129318a1c824d066fc2cd1e3911054460819c296ac99007aeb5044b6605.css integrity="sha256-hzXBKTGKHIJNBm/CzR45EQVEYIGcKWrJkAeutQRLZgU=" crossorigin=anonymous type=text/css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin=anonymous><link rel="shortcut icon" href=https://davidissamattos.github.io/favicons/favicon.icofavicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=https://davidissamattos.github.io/favicons/favicon.icoapple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://davidissamattos.github.io/favicons/favicon.icofavicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://davidissamattos.github.io/favicons/favicon.icofavicon-16x16.png><link rel=canonical href=https://davidissamattos.github.io/post/2021/packages-with-stan/><script type=text/javascript src=https://davidissamattos.github.io/js/anatole-header.min.df804b63b5bd8474ea0756ea874bc8f1e92552708cc6ea43aa0d76981dc419f9.js integrity="sha256-34BLY7W9hHTqB1bqh0vI8eklUnCMxupDqg12mB3EGfk=" crossorigin=anonymous></script><meta name=twitter:card content="summary"><meta name=twitter:title content="Writing R packages With Stan"><meta name=twitter:description content="Now, I have been developing the bpcs package for the last 4 months I thought of sharing a bit my experience with developing a R package with Stan."></head><body><div class="sidebar animated fadeInDown"><div class=logo-title><div class=title><img src=https://davidissamattos.github.io/images/profile.jpg alt="profile picture"><h3 title><a href=/>David Issa Mattos</a></h3><div class=description><p>I am interest in research, statistics and causal inference in the context of software development.</p></div></div></div><ul class=social-links><li><a href=mailto:issamattos.david@gmail.com rel=me aria-label=e-mail><i class="fas fa-envelope fa-2x" aria-hidden=true></i></a></li><li><a href=https://github.com/davidissamattos/ rel=me aria-label=GitHub><i class="fab fa-github fa-2x" aria-hidden=true></i></a></li><li><a href=https://www.linkedin.com/in/mattosdi/ rel=me aria-label=Linkedin><i class="fab fa-linkedin fa-2x" aria-hidden=true></i></a></li></ul><div class=footer><div class=by_farbox>&copy; David Issa Mattos 2020-2022</div></div></div><div class=main><div class="page-top animated fadeInDown"><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span></a><ul class=nav id=navMenu><li><a href=/ title>Home</a></li><li><a href=/post/ title>Posts</a></li><li><a href=/cv/ title>Curriculum vitae</a></li><li><a href=/publications/ title>Publications</a></li><li><a href=https://receitas.mattosdi.com target=_blank rel="noopener noreferrer" title>Receitas (em pt)</a></li><li><a href=/contact/ title>Contact</a></li></ul></div><div class=autopagerize_page_element><div class=content><div class="post animated fadeInDown"><div class=post-content><div class=post-title><h3>Writing R packages With Stan</h3><div class=info><em class="fas fa-calendar-day"></em>
<span class=date>Mon, Feb 15, 2021</span>
<em class="fas fa-stopwatch"></em>
<span class=reading-time>5-minute read</span></div></div><p>Now, I have been developing the <a href=https://github.com/davidissamattos/bpcs>bpcs</a> package for the last 4 months I thought of sharing a bit my experience with developing a R package with Stan.</p><h2 id=rstan--rstantools>rstan + rstantools</h2><p>My first experience was with <code>rstan</code> + <code>rstantools</code>. Creating a skeleton package based on <code>rstantools</code> is really fast and straightforward.</p><ul><li>During installation time, the Stan model is compiled and ready to be called. This creates a longer time in development if you are constantly changing the Stan model<ul><li>My experience is that it is best to have an almost-ready model before starting to iterate with the package. Alternatively, have a script where you can test the model without the need to install. The installation process to compile the model takes longer than just using rstan.<ul><li>Avoid having many models or you will be spending 20min in installation</li><li>This can create problems if you are submitting to CRAN</li><li>This can also create problems if you are using Github actions (since they limited time to run the CI)</li></ul></li><li>It is not always that changes in the model result in a re-compilation in Rstudio with devtools. Through some trial and error I found that to force recompilation you need:<ol><li><code>pkgbuild::clean_dll()</code> to clean the source files. This will force recompile &ndash;></li><li><code>devtools::document()</code>. This will update the package and recompile the model</li><li>Restart the r session to make the model reload in the memory</li><li>Run<code>devtools::load_all()</code> again. Now you are ready to test your recompiled model</li></ol></li></ul></li><li>I found problems when using the <code>rstan::gqs</code> function. To give some context, I fitted my model with <code>rstan::sample</code> (no problems here) and then I used <code>rstan::gqs</code> in a <code>predict</code> S3 function with the parameters fitted from the model.<ul><li>My problem here is that (I think) there are/were some bugs in the generated quantities in Stan.<ul><li>Estimated parameters could not be optional since they need to be present, so I needed to have transformed parameters to make sure all parameters were present</li><li>The transformed parameters did not play nice with the generated quantities and the recommended approach is to have the transformed parameters inside the generated quantities. This increases copy and paste in the model</li><li>With transformed parameters I was doing a lot of subsets (e.g. a parameter was a vector, the transformed parameters was a real and I was assigning to the real variable only the first item of the transformed parameter). Apparently, this creates a problem in CRAN with ubsan-clang where the Stan code is not properly compiled in clang and leads to memory errors in macOS. There are no tools to investigate this and there is a lot of trial and errors with a very specific setup. This lead me to change to <code>cmdstanr</code> in the package development.</li></ul></li></ul></li></ul><h2 id=cmdstanr>cmdstanr</h2><p>For version 1.2.0, I decided to change to <code>cmdstanr</code> instead of the <code>rstan</code> + <code>rstantools</code> combo. My decision was based on:</p><ul><li>Development and installation is much faster. <code>cmdstan</code> compiles the models faster.</li><li>New features are available almost immediatly. <code>rstan</code> is in version 2.21 while <code>cmdstan</code> in vesion 2.26</li><li>It is now the user responsibility to have a toolchain configured and working and to install <code>cmdstan</code>. If Stan changes its own recommended procedures this should not impact the package. <code>cmdstan</code> can be easily installed with <code>cmdstanr</code>, so this should not be an issue.</li><li>In my case it was <strong>worth going from <code>rstan</code> to <code>cmdstanr</code></strong></li></ul><p>Here a few thing to remember:</p><ul><li>To call the model you have placed in <code>inst/stan</code></li></ul><p>Problems that I have encountered so far:</p><ul><li>Generated quantities: as before I was trying to use the generated quantities in Stan for the predict function. However, the same model that compiled and worked with <code>rstan</code> stopped working in some of the <code>bpcs</code> use cases. The error message did not help much since the csv file is not even created. I <strong>suspect</strong> that this was the error that was appearing with ubsan-clang but now instead of a memory error in CRAN, this is caught in the <code>cmdstan</code>.<ul><li>Based on that I decided to move the generated quantities directly to R. This created a bit of code repetition (in R and in Stan), but now all models work properly. The code is a bit easier to debug and test. Performance impact was small for most of my test cases. I use a for loop for every observation in the prediciton dataset but for each posterior sample is vectorized. In the future, I plan to make everything vectorized, which should improve prediction perfomance for larger datasets.</li></ul></li><li>I my tests, I am sampling several test data sets to test different models combinations. Once in a while I have an error of not finding the csv file. It didn&rsquo;t seem to be systematic or dependent on a model<ul><li>These only appeared with testthat test and not when I run each one independently</li><li>This creates a problem with CI in Github actions and those nice badges in Github.</li></ul></li><li>No matter how much I tried, I could not use <code>#include</code> in the Stan model. It might be my poor R/Stan skills, but I just couldn&rsquo;t make it work in a package (I could make it work in a script though).</li><li>Of course you cannot submit to CRAN while <code>cmdstanr</code> is not in CRAN (hopefully they will have it there soon)</li></ul></div><div class=post-footer><div class=info><span class=separator><a class=tag href=/tags/r/>r</a><a class=tag href=/tags/stan/>Stan</a><a class=tag href=/tags/bayesian-statistics/>Bayesian statistics</a></span></div></div></div></div></div></div><script type=text/javascript src=https://davidissamattos.github.io/js/jquery.min.f88a644bd10c9d138dce83331832208e1dd14f624f823cdeb682e5783640dcd7.js integrity="sha256-+IpkS9EMnRONzoMzGDIgjh3RT2JPgjzetoLleDZA3Nc=" crossorigin=anonymous></script>
<script type=text/javascript src=https://davidissamattos.github.io/js/bundle.min.68448c0fea8bb43816d71227ea330e3d78416ab936b0844b449659d2d47dcab8.js integrity="sha256-aESMD+qLtDgW1xIn6jMOPXhBark2sIRLRJZZ0tR9yrg=" crossorigin=anonymous></script>
<script type=text/javascript src=https://davidissamattos.github.io/js/medium-zoom.min.404e25d56ecefa87be4f21be4a6883aa550b493b32677d13d7f47762dc3537cf.js integrity="sha256-QE4l1W7O+oe+TyG+SmiDqlULSTsyZ30T1/R3Ytw1N88=" crossorigin=anonymous></script></body></html>