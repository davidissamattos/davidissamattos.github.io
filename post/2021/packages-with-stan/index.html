<!doctype html><html lang=en><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Writing R packages With Stan | David's public blog</title><meta name=title content="Writing R packages With Stan"><meta name=description content="Now, I have been developing the bpcs package for the last 4 months I thought of sharing a bit my experience with developing a R package with Stan.
rstan + rstantools
My first experience was with rstan + rstantools. Creating a skeleton package based on rstantools is really fast and straightforward.

During installation time, the Stan model is compiled and ready to be called. This creates a longer time in development if you are constantly changing the Stan model

My experience is that it is best to have an almost-ready model before starting to iterate with the package. Alternatively, have a script where you can test the model without the need to install. The installation process to compile the model takes longer than just using rstan.

Avoid having many models or you will be spending 20min in installation
This can create problems if you are submitting to CRAN
This can also create problems if you are using Github actions (since they limited time to run the CI)


It is not always that changes in the model result in a re-compilation in Rstudio with devtools. Through some trial and error I found that to force recompilation you need:

pkgbuild::clean_dll() to clean the source files. This will force recompile &ndash;>
devtools::document(). This will update the package and recompile the model
Restart the r session to make the model reload in the memory
Rundevtools::load_all() again. Now you are ready to test your recompiled model




I found problems when using the rstan::gqs function. To give some context, I fitted my model with rstan::sample (no problems here) and then I used rstan::gqs in a predict S3 function with the parameters fitted from the model.

My problem here is that (I think) there are/were some bugs in the generated quantities in Stan.

Estimated parameters could not be optional since they need to be present, so I needed to have transformed parameters to make sure all parameters were present
The transformed parameters did not play nice with the generated quantities and the recommended approach is to have the transformed parameters inside the generated quantities. This increases copy and paste in the model
With transformed parameters I was doing a lot of subsets (e.g. a parameter was a vector, the transformed parameters was a real and I was assigning to the real variable only the first item of the transformed parameter). Apparently, this creates a problem in CRAN with ubsan-clang where the Stan code is not properly compiled in clang and leads to memory errors in macOS. There are no tools to investigate this and there is a lot of trial and errors with a very specific setup. This lead me to change to cmdstanr in the package development.





cmdstanr
For version 1.2.0, I decided to change to cmdstanr instead of the rstan + rstantools combo. My decision was based on:"><meta name=keywords content="r,Stan,Bayesian statistics,"><meta property="og:url" content="https://davidissamattos.github.io/post/2021/packages-with-stan/"><meta property="og:site_name" content="David's public blog"><meta property="og:title" content="Writing R packages With Stan"><meta property="og:description" content="Now, I have been developing the bpcs package for the last 4 months I thought of sharing a bit my experience with developing a R package with Stan.
rstan + rstantools My first experience was with rstan + rstantools. Creating a skeleton package based on rstantools is really fast and straightforward.
During installation time, the Stan model is compiled and ready to be called. This creates a longer time in development if you are constantly changing the Stan model My experience is that it is best to have an almost-ready model before starting to iterate with the package. Alternatively, have a script where you can test the model without the need to install. The installation process to compile the model takes longer than just using rstan. Avoid having many models or you will be spending 20min in installation This can create problems if you are submitting to CRAN This can also create problems if you are using Github actions (since they limited time to run the CI) It is not always that changes in the model result in a re-compilation in Rstudio with devtools. Through some trial and error I found that to force recompilation you need: pkgbuild::clean_dll() to clean the source files. This will force recompile –> devtools::document(). This will update the package and recompile the model Restart the r session to make the model reload in the memory Rundevtools::load_all() again. Now you are ready to test your recompiled model I found problems when using the rstan::gqs function. To give some context, I fitted my model with rstan::sample (no problems here) and then I used rstan::gqs in a predict S3 function with the parameters fitted from the model. My problem here is that (I think) there are/were some bugs in the generated quantities in Stan. Estimated parameters could not be optional since they need to be present, so I needed to have transformed parameters to make sure all parameters were present The transformed parameters did not play nice with the generated quantities and the recommended approach is to have the transformed parameters inside the generated quantities. This increases copy and paste in the model With transformed parameters I was doing a lot of subsets (e.g. a parameter was a vector, the transformed parameters was a real and I was assigning to the real variable only the first item of the transformed parameter). Apparently, this creates a problem in CRAN with ubsan-clang where the Stan code is not properly compiled in clang and leads to memory errors in macOS. There are no tools to investigate this and there is a lot of trial and errors with a very specific setup. This lead me to change to cmdstanr in the package development. cmdstanr For version 1.2.0, I decided to change to cmdstanr instead of the rstan + rstantools combo. My decision was based on:"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-02-15T00:00:00+00:00"><meta property="article:modified_time" content="2021-02-15T00:00:00+00:00"><meta property="article:tag" content="R"><meta property="article:tag" content="Stan"><meta property="article:tag" content="Bayesian Statistics"><meta name=twitter:card content="summary"><meta name=twitter:title content="Writing R packages With Stan"><meta name=twitter:description content="Now, I have been developing the bpcs package for the last 4 months I thought of sharing a bit my experience with developing a R package with Stan.
rstan + rstantools My first experience was with rstan + rstantools. Creating a skeleton package based on rstantools is really fast and straightforward.
During installation time, the Stan model is compiled and ready to be called. This creates a longer time in development if you are constantly changing the Stan model My experience is that it is best to have an almost-ready model before starting to iterate with the package. Alternatively, have a script where you can test the model without the need to install. The installation process to compile the model takes longer than just using rstan. Avoid having many models or you will be spending 20min in installation This can create problems if you are submitting to CRAN This can also create problems if you are using Github actions (since they limited time to run the CI) It is not always that changes in the model result in a re-compilation in Rstudio with devtools. Through some trial and error I found that to force recompilation you need: pkgbuild::clean_dll() to clean the source files. This will force recompile –> devtools::document(). This will update the package and recompile the model Restart the r session to make the model reload in the memory Rundevtools::load_all() again. Now you are ready to test your recompiled model I found problems when using the rstan::gqs function. To give some context, I fitted my model with rstan::sample (no problems here) and then I used rstan::gqs in a predict S3 function with the parameters fitted from the model. My problem here is that (I think) there are/were some bugs in the generated quantities in Stan. Estimated parameters could not be optional since they need to be present, so I needed to have transformed parameters to make sure all parameters were present The transformed parameters did not play nice with the generated quantities and the recommended approach is to have the transformed parameters inside the generated quantities. This increases copy and paste in the model With transformed parameters I was doing a lot of subsets (e.g. a parameter was a vector, the transformed parameters was a real and I was assigning to the real variable only the first item of the transformed parameter). Apparently, this creates a problem in CRAN with ubsan-clang where the Stan code is not properly compiled in clang and leads to memory errors in macOS. There are no tools to investigate this and there is a lot of trial and errors with a very specific setup. This lead me to change to cmdstanr in the package development. cmdstanr For version 1.2.0, I decided to change to cmdstanr instead of the rstan + rstantools combo. My decision was based on:"><meta itemprop=name content="Writing R packages With Stan"><meta itemprop=description content="Now, I have been developing the bpcs package for the last 4 months I thought of sharing a bit my experience with developing a R package with Stan.
rstan + rstantools My first experience was with rstan + rstantools. Creating a skeleton package based on rstantools is really fast and straightforward.
During installation time, the Stan model is compiled and ready to be called. This creates a longer time in development if you are constantly changing the Stan model My experience is that it is best to have an almost-ready model before starting to iterate with the package. Alternatively, have a script where you can test the model without the need to install. The installation process to compile the model takes longer than just using rstan. Avoid having many models or you will be spending 20min in installation This can create problems if you are submitting to CRAN This can also create problems if you are using Github actions (since they limited time to run the CI) It is not always that changes in the model result in a re-compilation in Rstudio with devtools. Through some trial and error I found that to force recompilation you need: pkgbuild::clean_dll() to clean the source files. This will force recompile –> devtools::document(). This will update the package and recompile the model Restart the r session to make the model reload in the memory Rundevtools::load_all() again. Now you are ready to test your recompiled model I found problems when using the rstan::gqs function. To give some context, I fitted my model with rstan::sample (no problems here) and then I used rstan::gqs in a predict S3 function with the parameters fitted from the model. My problem here is that (I think) there are/were some bugs in the generated quantities in Stan. Estimated parameters could not be optional since they need to be present, so I needed to have transformed parameters to make sure all parameters were present The transformed parameters did not play nice with the generated quantities and the recommended approach is to have the transformed parameters inside the generated quantities. This increases copy and paste in the model With transformed parameters I was doing a lot of subsets (e.g. a parameter was a vector, the transformed parameters was a real and I was assigning to the real variable only the first item of the transformed parameter). Apparently, this creates a problem in CRAN with ubsan-clang where the Stan code is not properly compiled in clang and leads to memory errors in macOS. There are no tools to investigate this and there is a lot of trial and errors with a very specific setup. This lead me to change to cmdstanr in the package development. cmdstanr For version 1.2.0, I decided to change to cmdstanr instead of the rstan + rstantools combo. My decision was based on:"><meta itemprop=datePublished content="2021-02-15T00:00:00+00:00"><meta itemprop=dateModified content="2021-02-15T00:00:00+00:00"><meta itemprop=wordCount content="873"><meta itemprop=keywords content="R,Stan,Bayesian Statistics"><meta name=referrer content="no-referrer-when-downgrade"><style>:root{--width:720px;--font-main:Verdana, sans-serif;--font-secondary:Verdana, sans-serif;--font-scale:1em;--background-color:#fff;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--blockquote-color:#222}@media(prefers-color-scheme:dark){:root{--background-color:#01242e;--heading-color:#eee;--text-color:#ddd;--link-color:#8cc2dd;--visited-color:#8b6fcb;--blockquote-color:#ccc}}body{font-family:var(--font-secondary);font-size:var(--font-scale);margin:auto;padding:20px;max-width:var(--width);text-align:left;background-color:var(--background-color);word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:var(--text-color)}h1,h2,h3,h4,h5,h6{font-family:var(--font-main);color:var(--heading-color)}a{color:var(--link-color);cursor:pointer;text-decoration:none}a:hover{text-decoration:underline}nav a{margin-right:8px}strong,b{color:var(--heading-color)}button{margin:0;cursor:pointer}time{font-family:monospace;font-style:normal;font-size:15px}main{line-height:1.6}table{width:100%}hr{border:0;border-top:1px dashed}img{max-width:100%}code{font-family:monospace;padding:2px;border-radius:3px}blockquote{border-left:1px solid #999;color:var(--blockquote-color);padding-left:20px;font-style:italic}footer{padding:25px 0;text-align:center}.title:hover{text-decoration:none}.title h1{font-size:1.5em}.inline{width:auto!important}.highlight,.code{border-radius:3px;margin-block-start:1em;margin-block-end:1em;overflow-x:auto}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:var(--visited-color)}</style><script src=https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.9.2/build/opensheetmusicdisplay.min.js></script></head><body><header><a href=/ class=title><h2>David's public blog</h2></a><nav><a href=/>Home</a>
<a href=/post/>Posts</a>
<a href=/music/>Music</a>
<a href=/contact/>Contact</a></nav></header><main><content><p>Now, I have been developing the <a href=https://github.com/davidissamattos/bpcs>bpcs</a> package for the last 4 months I thought of sharing a bit my experience with developing a R package with Stan.</p><h2 id=rstan--rstantools>rstan + rstantools</h2><p>My first experience was with <code>rstan</code> + <code>rstantools</code>. Creating a skeleton package based on <code>rstantools</code> is really fast and straightforward.</p><ul><li>During installation time, the Stan model is compiled and ready to be called. This creates a longer time in development if you are constantly changing the Stan model<ul><li>My experience is that it is best to have an almost-ready model before starting to iterate with the package. Alternatively, have a script where you can test the model without the need to install. The installation process to compile the model takes longer than just using rstan.<ul><li>Avoid having many models or you will be spending 20min in installation</li><li>This can create problems if you are submitting to CRAN</li><li>This can also create problems if you are using Github actions (since they limited time to run the CI)</li></ul></li><li>It is not always that changes in the model result in a re-compilation in Rstudio with devtools. Through some trial and error I found that to force recompilation you need:<ol><li><code>pkgbuild::clean_dll()</code> to clean the source files. This will force recompile &ndash;></li><li><code>devtools::document()</code>. This will update the package and recompile the model</li><li>Restart the r session to make the model reload in the memory</li><li>Run<code>devtools::load_all()</code> again. Now you are ready to test your recompiled model</li></ol></li></ul></li><li>I found problems when using the <code>rstan::gqs</code> function. To give some context, I fitted my model with <code>rstan::sample</code> (no problems here) and then I used <code>rstan::gqs</code> in a <code>predict</code> S3 function with the parameters fitted from the model.<ul><li>My problem here is that (I think) there are/were some bugs in the generated quantities in Stan.<ul><li>Estimated parameters could not be optional since they need to be present, so I needed to have transformed parameters to make sure all parameters were present</li><li>The transformed parameters did not play nice with the generated quantities and the recommended approach is to have the transformed parameters inside the generated quantities. This increases copy and paste in the model</li><li>With transformed parameters I was doing a lot of subsets (e.g. a parameter was a vector, the transformed parameters was a real and I was assigning to the real variable only the first item of the transformed parameter). Apparently, this creates a problem in CRAN with ubsan-clang where the Stan code is not properly compiled in clang and leads to memory errors in macOS. There are no tools to investigate this and there is a lot of trial and errors with a very specific setup. This lead me to change to <code>cmdstanr</code> in the package development.</li></ul></li></ul></li></ul><h2 id=cmdstanr>cmdstanr</h2><p>For version 1.2.0, I decided to change to <code>cmdstanr</code> instead of the <code>rstan</code> + <code>rstantools</code> combo. My decision was based on:</p><ul><li>Development and installation is much faster. <code>cmdstan</code> compiles the models faster.</li><li>New features are available almost immediatly. <code>rstan</code> is in version 2.21 while <code>cmdstan</code> in vesion 2.26</li><li>It is now the user responsibility to have a toolchain configured and working and to install <code>cmdstan</code>. If Stan changes its own recommended procedures this should not impact the package. <code>cmdstan</code> can be easily installed with <code>cmdstanr</code>, so this should not be an issue.</li><li>In my case it was <strong>worth going from <code>rstan</code> to <code>cmdstanr</code></strong></li></ul><p>Here a few thing to remember:</p><ul><li>To call the model you have placed in <code>inst/stan</code></li></ul><p>Problems that I have encountered so far:</p><ul><li>Generated quantities: as before I was trying to use the generated quantities in Stan for the predict function. However, the same model that compiled and worked with <code>rstan</code> stopped working in some of the <code>bpcs</code> use cases. The error message did not help much since the csv file is not even created. I <strong>suspect</strong> that this was the error that was appearing with ubsan-clang but now instead of a memory error in CRAN, this is caught in the <code>cmdstan</code>.<ul><li>Based on that I decided to move the generated quantities directly to R. This created a bit of code repetition (in R and in Stan), but now all models work properly. The code is a bit easier to debug and test. Performance impact was small for most of my test cases. I use a for loop for every observation in the prediciton dataset but for each posterior sample is vectorized. In the future, I plan to make everything vectorized, which should improve prediction perfomance for larger datasets.</li></ul></li><li>I my tests, I am sampling several test data sets to test different models combinations. Once in a while I have an error of not finding the csv file. It didn&rsquo;t seem to be systematic or dependent on a model<ul><li>These only appeared with testthat test and not when I run each one independently</li><li>This creates a problem with CI in Github actions and those nice badges in Github.</li></ul></li><li>No matter how much I tried, I could not use <code>#include</code> in the Stan model. It might be my poor R/Stan skills, but I just couldn&rsquo;t make it work in a package (I could make it work in a script though).</li><li>Of course you cannot submit to CRAN while <code>cmdstanr</code> is not in CRAN (hopefully they will have it there soon)</li></ul></content><p><a href=https://davidissamattos.github.io/tags/r/>#R</a>
<a href=https://davidissamattos.github.io/tags/stan/>#Stan</a>
<a href=https://davidissamattos.github.io/tags/bayesian-statistics/>#Bayesian Statistics</a></p></main><footer></footer></body></html>