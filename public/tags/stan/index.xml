<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Stan on David&#39;s public blog</title>
    <link>http://localhost:1313/tags/stan/</link>
    <description>Recent content in Stan on David&#39;s public blog</description>
    <generator>Hugo</generator>
    <language>en</language>
    <lastBuildDate>Mon, 15 Feb 2021 00:00:00 +0000</lastBuildDate>
    <atom:link href="http://localhost:1313/tags/stan/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Writing R packages With Stan</title>
      <link>http://localhost:1313/post/2021/packages-with-stan/</link>
      <pubDate>Mon, 15 Feb 2021 00:00:00 +0000</pubDate>
      <guid>http://localhost:1313/post/2021/packages-with-stan/</guid>
      <description>&lt;p&gt;Now, I have been developing the &lt;a href=&#34;https://github.com/davidissamattos/bpcs&#34;&gt;bpcs&lt;/a&gt; package for the last 4 months I thought of sharing a bit my experience with developing a R package with Stan.&lt;/p&gt;&#xA;&lt;h2 id=&#34;rstan--rstantools&#34;&gt;rstan + rstantools&lt;/h2&gt;&#xA;&lt;p&gt;My first experience was with &lt;code&gt;rstan&lt;/code&gt; + &lt;code&gt;rstantools&lt;/code&gt;. Creating a skeleton package based on &lt;code&gt;rstantools&lt;/code&gt; is really fast and straightforward.&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;During installation time, the Stan model is compiled and ready to be called. This creates a longer time in development if you are constantly changing the Stan model&#xA;&lt;ul&gt;&#xA;&lt;li&gt;My experience is that it is best to have an almost-ready model before starting to iterate with the package. Alternatively, have a script where you can test the model without the need to install. The installation process to compile the model takes longer than just using rstan.&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Avoid having many models or you will be spending 20min in installation&lt;/li&gt;&#xA;&lt;li&gt;This can create problems if you are submitting to CRAN&lt;/li&gt;&#xA;&lt;li&gt;This can also create problems if you are using Github actions (since they limited time to run the CI)&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;It is not always that changes in the model result in a re-compilation in Rstudio with devtools. Through some trial and error I found that to force recompilation you need:&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&lt;code&gt;pkgbuild::clean_dll()&lt;/code&gt; to clean the source files. This will force recompile &amp;ndash;&amp;gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;devtools::document()&lt;/code&gt;. This will update the package and recompile the model&lt;/li&gt;&#xA;&lt;li&gt;Restart the r session to make the model reload in the memory&lt;/li&gt;&#xA;&lt;li&gt;Run&lt;code&gt;devtools::load_all()&lt;/code&gt; again. Now you are ready to test your recompiled model&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;I found problems when using the &lt;code&gt;rstan::gqs&lt;/code&gt; function. To give some context, I fitted my model with &lt;code&gt;rstan::sample&lt;/code&gt; (no problems here) and then I used &lt;code&gt;rstan::gqs&lt;/code&gt; in a &lt;code&gt;predict&lt;/code&gt; S3 function with the parameters fitted from the model.&#xA;&lt;ul&gt;&#xA;&lt;li&gt;My problem here is that (I think) there are/were some bugs in the generated quantities in Stan.&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Estimated parameters could not be optional since they need to be present, so I needed to have transformed parameters to make sure all parameters were present&lt;/li&gt;&#xA;&lt;li&gt;The transformed parameters did not play nice with the generated quantities and the recommended approach is to have the transformed parameters inside the generated quantities. This increases copy and paste in the model&lt;/li&gt;&#xA;&lt;li&gt;With transformed parameters I was doing a lot of subsets (e.g. a parameter was a vector, the transformed parameters was a real and I was assigning to the real variable only the first item of the transformed parameter). Apparently, this creates a problem in CRAN with ubsan-clang where the Stan code is not properly compiled in clang and leads to memory errors in macOS. There are no tools to investigate this and there is a lot of trial and errors with a very specific setup. This lead me to change to &lt;code&gt;cmdstanr&lt;/code&gt; in the package development.&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h2 id=&#34;cmdstanr&#34;&gt;cmdstanr&lt;/h2&gt;&#xA;&lt;p&gt;For version 1.2.0, I decided to change to &lt;code&gt;cmdstanr&lt;/code&gt; instead of the &lt;code&gt;rstan&lt;/code&gt; + &lt;code&gt;rstantools&lt;/code&gt; combo. My decision was based on:&lt;/p&gt;</description>
    </item>
  </channel>
</rss>
